---
updated: "2018-08-20"
layout: post
title: 分布式数据库
list_title: 系统设计 | System Design | 分布式数据库 | Distributed Database
categories: [backend]
---

高性能数据库集群的设计方式有很多种，其中比较重要的有两种方式，一种是读写分离，其本质是将访问压力分散到集群中的过个节点上，但是存储压力并没有分散；第二种方式是分库分表，用来分散从存储，降低单机存储压力。

## 读写分离

读写分离的基本原理是将数据库读写操作分散到不同的节点上，常用的策略有“主从”，“主主”

<img src="{{site.baseurl}}/assets/images/2016/05/sd-5-1.png">

读写分离的基本操作为

1. 数据库服务器建立主从集群
2. 数据库master负责读写操作，slave负责读操作
3. 数据库master通过复制将数据同步到slave，每台数据库内容相同
4. 业务服务器将写操作发给master，读操作发到slave上

上述过程并不难理解，但是这里面的关键问题是，主从数据如何保持一致性。即当有写出操作发生时，master如何将数据同步给slave。以 MySQL 为例，主从复制延迟可能达到 1 秒，如果有大量数据同步，延迟 1 分钟也是有可能的。主从复制延迟会带来一个问题：如果业务服务器将数据写入到数据库主服务器后立刻（1 秒内）进行读取，此时读操作访问的是从机，主机还没有将数据复制过来，到从机读取数据是读不到最新数据的，业务上就可能出现问题。例如，用户刚注册完后立刻登录，业务服务器会提示他“你还没有注册”，而用户明明刚才已经注册成功了。

### 数据一致性

解决数据同步问题有几种常用的方法：

1. 写操作完成后的读操作全部指向master
    例如，注册账号完成后，登录时读取账号的读操作也发给数据库主服务器。显然这种方式对业务代码并不友好，程序要需要在代码中实现这段逻辑，和业务代码强绑定，难以维护。
2. 读slave失败后转而去读master
    这种方式也叫做“二次读取”，二次读取和业务无绑定，只需要对底层数据库访问的 API 进行封装即可，实现代价较小，不足之处在于如果有很多二次读取，将大大增加主机的读操作压力。例如，黑客暴力破解账号，会导致大量的二次读取操作，主机可能顶不住读操作的压力从而崩溃。
3. 关键业务读写均指向master，非关键业务采用读写分离
    这是比较常用的一种方式，重要的业务例如注册+登录全部由master完成，非重要业务及时数据短暂的不一致，也并不会对业务造成太大的影响。

### 访问代理

想要实现上述选择数据库读写的逻辑有很多种方法，简单做法可以在App Server和DB集群中间做一个适配层，适配层对业务层保持透明，业务代码可以像调用DB一样调用适配层接口，适配层和DB集群的通信则被封装在自己内部，这样可以将业务逻辑和DB调用的逻辑隔离开，DB的变化（比如主从切换）对业务无感知，只需在适配层修改即可，如下图所示：

<img src="{{site.baseurl}}/assets/images/2016/05/sd-5-2.png">

适配层的实现可以采用代码形式，比如封装一个`jar`包提供各业务方调用；也可以独立出一套中间件系统出来，做数据库连接池。前者比较轻量，后者的工作量会很大，复杂度也会比前者高出一个数量级。一般情况下建议采用程序语言封装的方式，或者使用成熟的开源数据库中间件。如果是大公司，可以投入人力去实现数据库中间件，因为这个系统一旦做好，接入的业务系统越多，节省的程序开发投入就越多，价值也越大。

## 分库分表

读写分离分散了数据库请求的压力，但是没有分散存储压力，当数据量达到千万甚至上亿条的时候，单台数据库服务器的存储能力会成为系统的瓶颈，主要体现在这几个方面：

1. 数据量太大，读写的性能会下降，即使有索引，索引也会变得很大，性能同样会下降。
2. 数据文件会变得很大，数据库备份和恢复需要耗费很长时间。
3. 数据文件越大，极端情况下丢失数据的风险越高（例如，机房火灾导致数据库主备机都发生故障）。

基于上述原因，单个数据库的存储数据量不能太大，需要控制在一定范围内，当数据量持续增加时，需要考虑将数据分散存储在多台DB服务器上。分散存储的方法主要有两个，一个是分库，一个是分表

### 分库

分库是指是指按照业务模块将数据分散到不同的数据库服务器上，例如下面一台DB中同时存放了用户，订单，评论三个业务模块的数据

<img class="md-img-center" src="{{site.baseurl}}/assets/images/2016/05/sd-5-3.png">

我们可以将用户，订单，评论三个模块的数据分开放到三台不同的数据库服务器上，这样单台服务器的存储压力就会大幅下降。但与此同时，分库也带来了更多的问题：

1. JOIN操作问题

    业务分库后，原本在同一个库中的表分散到不同数据库中，导致无法进行JOIN查询，例如下面SQL语句

    ```SQL
    <!-- Join customer table with payment table -->
    SELECT 
    customer.customer_id, first_name,last_name,email,
    amount,payment_date
    FROM customer
    INNER JOIN payment ON payment.customer_id = customer.customer_id;
    ```
    上面查询语句中用来查询每个用户的交易记录，first_name,last_name,email来自customer表，amount，payment_date来自payment表，两个表之间通过customer_id进行关联。
